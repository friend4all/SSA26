# 15. Развёртывание контроллера домена на базе SambaAD

### Вариант реализации:

#### 

#### dc-a (alt-server):

* Временно для возможности установки необходимых пакетов зададим публичный DNS-сервер:

```bash
echo "nameserver 77.88.8.8" > /etc/resolv.conf
```

* Устанавливаем пакеты **task-samba-dc, bind** и **bind-utils**:

```bash
apt-get update && apt-get install -y task-samba-dc bind bind-utils
```

* Если при установке системы в настройках сети было указано полное имя домена (например, dc-a.office.ssa2026.region), система может автоматически создать зону office.ssa2026.region, что приведёт к конфликту с Samba при запуске bind
* Для решения проблемы необходимо закомментировать все строки в файле **/etc/bind/local.conf**, это предотвратит автозагрузку конфликтующих зон:

![](../images/15_image_c4471a16ef.png)

* Отключите chroot:

```bash
control bind-chroot disabled
```

* Отключите KRB5RCACHETYPE:

```bash
echo 'KRB5RCACHETYPE="none"' >> /etc/sysconfig/bind
```

* Подключите плагин BIND\_DLZ:

```bash
echo 'include "/var/lib/samba/bind-dns/named.conf";' >> /etc/bind/named.conf
```

* Отредактируйте файл **/etc/bind/options.conf**:
  + в раздел **options** добавьте строки:
    - **tkey-gssapi-keytab** — путь к ключевой таблице для GSS-API (интеграция с Kerberos);
    - **minimal-responses** — уменьшает объём ответов;
    - **listen-on** — IP-адреса, на которых принимаются запросы;
    - **allow-query** — разрешённые подсети для DNS-запросов;
    - **allow-recursion** — подсети, которым разрешены рекурсивные запросы;
    - **forwarders** — внешние DNS-серверы для пересылки;;
    - **forward first** — сначала пересылать, затем кешировать;

![](../images/15_image__1__13d1ce5458.png)

* + в раздел **logging** добавьте строку:
    - **logging** —  подавление предупреждений о «lame servers»

![](../images/15_image__2__377ecf0b7b.png)

* Восстановить к начальному состоянию Samba:

```bash
rm -f /etc/samba/smb.conf
```

```bash
rm -f /etc/samba/smb.conf
```

```bash
rm -rf /var/cache/samba
```

```bash
mkdir -p /var/lib/samba/sysvol
```

* Интерактивное создание домена:

```bash
samba-tool domain provision
```

* + в качестве **DNS backend** указать **BIND9\_DLZ**

![](../images/15_image__3__9ce6020e88.png)

* + результат успешного создания домена в интерактивном режиме:

![](../images/15_image__4__5a4a68e117.png)

* Включить в автозагрузку службы **samba** и **bind,** также запустить их:

```bash
systemctl enable --now samba
```

```bash
systemctl enable --now bind
```

* При создании домена Samba автоматически генерирует корректный файл **krb5.conf** для домена в каталоге **/var/lib/samba/private/**
  + Можно просто заменить этим файлом файл, находящийся в каталоге **/etc/**:

```bash
cp /var/lib/samba/private/krb5.conf /etc/krb5.conf
```

* Перезагрузить службу **samba**:

```bash
systemctl restart samba
```

* Просмотр общей информации о домене можно выполнить с помощью команды **samba-tool domain info 127.0.0.1**:

![](../images/15_image__5__92e1b5118b.png)

* Просмотр предоставляемых служб можно выполнить с помощью команды **smbclient -L localhost -Uadministrator**:
  + **netlogon** и **sysvol** создаются автоматически и необходимы для работы контроллера домена

![](../images/15_image__6__a446938d00.png)

* Проверка конфигурации DNS:
  + проверка наличия **nameserver 127.0.0.1** в **/etc/resolv.conf**:

![](../images/15_image__7__61c351caa2.png)

* + проверка имён хостов "**\_kerberos.\_udp.**":

![](../images/15_image__8__69bf691e86.png)

* + проверка имён хостов "**\_ldap.\_tcp.**":

![](../images/15_image__9__3ec25125c6.png)

* + проверка имён хостов "**адрес хоста.**":

![](../images/15_image__10__b128172fcf.png)

* Проверка Kerberos-аутентификации (имя домена должно быть в верхнем регистре):

![](../images/15_image__11__40a392bb66.png)

* Просмотр полученного билета:

![](../images/15_image__12__41bc498c1a.png)

#### cli1-a и cli2-a (alt-workstation):

* Для ввода в дломен установим пакет **task-auth-ad-sssd**:

```bash
apt-get update && apt-get install -y task-auth-ad-sssd
```

* Для ввода компьютера в домен в **ЦУС** необходимо выбрать пункт **Пользователи** → **Аутентификация**
* В окне модуля **Аутентификация** следует выбрать пункт **Домен Active Directory**, заполнить поля (Домен, Рабочая группа, Имя компьютера), выбрать пункт SSSD (в единственном домене) и нажать кнопку **Применить**

![](../images/15_image__13__519a48eec3.png)

* В открывшемся окне необходимо ввести имя пользователя, имеющего право вводить машины в домен, и его пароль и нажать кнопку **ОК**:

![](../images/15_image__14__889ed80792.png)

* Результат успешного присоединения к домену:

![](../images/15_image__15__6c307a2a2d.png)

* Перезагрузить рабочую станцию для применения всех настроек

#### cli1-a (alt-workstation):

* Установить пакет **admc**:

```bash
apt-get install -y admc
```

* Запуск **ADMC** осуществляется из меню запуска приложений: пункт **Системные** → **ADMC** или из командной строки (команда **admc**)
* Для запуска ADMC необходимо предварительно получить ключ Kerberos для администратора домена:

![](../images/15_image__16__2bfe476f89.png)

* Результат успешного запуска **admc**:

![](../images/15_image__17__b54e3cf872.png)

* Создать **ofadmins**:

![](../images/15_image__18__bed33d4569.png)

* Создать **ofusers**:

![](../images/15_image__19__d3726080e4.png)

* Создать группу **ofadmins** в подразделение **ofadmins**:

![](../images/15_image__20__99324a2871.png)

* Создать группу **ofusers** в подразделение **ofusers**:

![](../images/15_image__21__c702b6272d.png)

* Создать пользователя **ofadmin1** в подразделение **ofadmins**:

![](../images/15_image__22__d6b7cca2f3.png)

* + Добавить созданного пользователя в группу **ofadmins**:

![](../images/15_image__23__e58161ee02.png)

* Создать пользователя **ofuser1** в подразделение **ofusers**
  + Добавить созданного пользователя в группу **ofusers**

![](../images/15_image__24__66ba72e636.png)

* Создать пользователя **user1**:

![](../images/15_image__25__a37eeac1e7.png)

#### cli2-a или cli1-a (alt-workstation):

* Проверить возможность входа из-под созданных пользователей:
  + **ofadmin1:**

![](../images/15_image__26__77ec7129ba.png)

* + **ofuser1:**

![](../images/15_image__27__8022f1a909.png)

* + **user1:**

![](../images/15_image__28__5c7c43355e.png)

#### cli1-a и cli2-a (alt-workstation):

* Необходимо установить пакет **gpupdate**:

```bash
apt-get install -y gpupdate
```

* Включить модуль групповых политик:

```bash
gpupdate-setup enable
```

#### cli1-a (alt-workstation):

* Установим пакет **gpui**, для редактирования настроек клиентской конфигурации:

```bash
apt-get install -y gpui
```

* В оснастке ADMC - переходим в раздел **Объекты групповой политики -> ПКМ**по **office.ssa2026.region** и нажимаем **Создать политику и связать с этом подразделением**:

![](../images/15_image__29__a0c3c13629.png)

* Задаём имя и нажимаем **ОК**:

![](../images/15_image__30__ecd1026a17.png)

* Выбираем созданную групповую политику **ПКМ** и нажимаем **Изменить**:

![](../images/15_image__31__a8c59a1caf.png)

* В соответствие с требованиями задания - реализуем необходимый функционал:
  + Задаём картинку компании для рабочего стола и запрещаем её менять
    - но, чтобы на **cli2-a** (или же из под любого другого пользователя) картинка также была установлена, её необходимо разместить на общем ресурсе (например, создав общую папку)

![](../images/15_image__32__3c534ed9f3.png)

* + - опционально (необязательно):

![](https://sysahelper.ru/pluginfile.php/1114/mod_page/content/13/image%20%2833%29.png)

* + Запрещаем изменение сетевых настроек:
    - пройтись по всему списку и выставить **Включено**, с вариантом ограничений **No** (выставить чек-бокс **Блокировать**):

![](https://sysahelper.ru/pluginfile.php/1114/mod_page/content/13/image%20%2834%29.png)

* Проверить, перезагружаем **cli1-a**и **cli2-a**:
  + картинка фона рабочего стола должна быть установлена:

![](https://sysahelper.ru/pluginfile.php/1114/mod_page/content/13/image%20%2835%29.png)

* + при попытке отключить сетевой интерфейс, данная возможность отсутствует:

![](https://sysahelper.ru/pluginfile.php/1114/mod_page/content/13/image%20%2836%29.png)

Последнее изменение: среда, 19 ноября 2025, 14:16